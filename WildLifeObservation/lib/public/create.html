<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tier erstellen</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/createstyles.css" />
</head>
<body>
  <div class="hero">
    <div class="overlay">
      <div class="form-container">
        <div class="form-header">
          <img src="/img/LogoWildLifeObservation.png" alt="Logo" />
          <h2>Tier erstellen</h2>
        </div>

        <form id="createForm">
          <div class="form-row">
            <!-- Animal -->
            <div class="form-section">
              <h3>Tierdaten (Animal)</h3>
              <label>Geschlecht:</label>
              <input name="gender" required />

              <label>Geschätztes Alter:</label>
              <input type="number" name="estimatedAge" required />

              <label>Geschätzte Größe (cm):</label>
              <input type="number" name="estimatedSize" step="0.01" required />

              <label>Geschätztes Gewicht (kg):</label>
              <input type="number" name="estimatedWeight" step="0.01" required />

              <label>Bild hochladen:</label>
              <input type="file" name="image" accept="image/*" />
            </div>

            <!-- Genus -->
            <div class="form-section">
              <h3>Gattung (Genus)</h3>
              <label>Lateinischer Name:</label>
              <input name="latinDesignation" required />

              <label>Deutsche Bezeichnung:</label>
              <input name="designation" required />

              <label>Beschreibung:</label>
              <input name="description" required />

              <label>Familie:</label>
              <input name="family" required />

              <label>Ernährung:</label>
              <input name="diet" required />

              <label>Fortpflanzung:</label>
              <input name="reproductiveStrategy" required />

              <label>Aktivitätsmuster:</label>
              <input name="activeCycle" required />

              <label>Sozialstruktur:</label>
              <input name="socialStructure" required />

              <label>Lebenserwartung:</label>
              <input name="lifeSpan" required />
            </div>

            <!-- Observation + Location -->
            <div class="form-section">
              <h3>Beobachtungsort (Location)</h3>
              <label>Titel:</label>
              <input name="locationShortTitle" required />

              <label>Beschreibung:</label>
              <input name="locationDescription" required />

              <label>Datum der Beobachtung:</label>
              <input type="date" name="date" required />

              <label>Uhrzeit der Beobachtung:</label>
              <input type="time" name="time" required />

              <button type="submit">Eintragen</button>
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>

  <script>
    document.getElementById('createForm').addEventListener('submit', async function (event) {
      event.preventDefault();

      const form = event.target;

      const animalData = {
        gender: form.gender.value,
        estimatedAge: parseInt(form.estimatedAge.value),
        estimatedSize: parseFloat(form.estimatedSize.value),
        estimatedWeight: parseFloat(form.estimatedWeight.value),

        latinDesignation: form.latinDesignation.value,
        designation: form.designation.value,
        description: form.description.value,
        family: form.family.value,
        diet: form.diet.value,
        reproductiveStrategy: form.reproductiveStrategy.value,
        activeCycle: form.activeCycle.value,
        socialStructure: form.socialStructure.value,
        lifeSpan: form.lifeSpan.value,

        locationShortTitle: form.locationShortTitle.value,
        locationDescription: form.locationDescription.value,
        date: form.date.value,
        time: form.time.value
      };

      try {
        // Tierdaten senden
        const response = await fetch('/animal-full', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(animalData)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error("Fehler bei der Erstellung: " + errorText);
        }

        // Falls Bild vorhanden: separat hochladen
        const imageFile = form.image.files[0];
        if (imageFile) {
          const animals = await fetch('/animal');
          const allAnimals = await animals.json();
          const latestAnimal = allAnimals[allAnimals.length - 1];
          const animalId = latestAnimal.id;

          const imageForm = new FormData();
          imageForm.append('file', imageFile);

          const imgResponse = await fetch(`/animal/${animalId}/image`, {
            method: 'POST',
            body: imageForm
          });

          if (!imgResponse.ok) {
            throw new Error("Tier erstellt, aber Bild-Upload fehlgeschlagen.");
          }
        }

        alert("✅ Tier erfolgreich erstellt!");
        form.reset();
      } catch (err) {
        alert("❌ " + err.message);
      }
    });
  </script>
</body>
</html>
