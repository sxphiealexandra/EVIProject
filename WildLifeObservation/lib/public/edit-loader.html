<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tier bearbeiten</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/createstyles.css" />
  <link rel="stylesheet" href="css/editloaderstyles.css" />
</head>
<body>
  <div class="hero">
    <div class="overlay">
      <div class="form-container">
        <div class="form-header">
          <img src="/img/LogoWildLifeObservation.png" alt="Logo" />
          <h2>Tier bearbeiten</h2>
        </div>
        <form id="editForm">
          <div class="form-row">

            <!-- Animal -->
            <div class="form-section">
              <h3>Tierdaten (Animal)</h3>
              <label>Geschlecht:</label>
              <input name="gender" required />
              <label>Geschätztes Alter:</label>
              <input type="number" name="estimatedAge" required />
              <label>Geschätzte Größe (cm):</label>
              <input type="number" name="estimatedSize" step="0.01" required />
              <label>Geschätztes Gewicht (kg):</label>
              <input type="number" name="estimatedWeight" step="0.01" required />

              <label>Bild hochladen (optional):</label>
              <input type="file" name="image" accept="image/*" onchange="previewImage(event)" />

              <p style="color:white; font-size: 0.9rem; margin-top: 0.3rem;">
                Wenn kein neues Bild ausgewählt wird, bleibt das bestehende erhalten.
              </p>

              <label>Aktuelles Bild:</label>
              <img id="currentImage" src="" alt="Kein Bild vorhanden" style="max-width: 100%; border: 1px solid #ccc; margin-top: 0.5rem; border-radius: 6px;" />
              <button type="button" onclick="deleteImage()" style="margin-top: 0.7rem; background-color: crimson;">Bild löschen</button>

              <div id="previewContainer" style="margin-top: 1rem;">
                <img id="previewImage" style="max-width: 100%; display: none; border-radius: 6px;" />
              </div>
            </div>

            <!-- Genus -->
            <div class="form-section">
              <h3>Gattung (Genus)</h3>
              <label>Lateinischer Name:</label>
              <input name="latinDesignation" required />
              <label>Deutsche Bezeichnung:</label>
              <input name="designation" required />
              <label>Beschreibung:</label>
              <input name="description" required />
              <label>Familie:</label>
              <input name="family" required />
              <label>Ernährung:</label>
              <input name="diet" required />
              <label>Fortpflanzung:</label>
              <input name="reproductiveStrategy" required />
              <label>Aktivitätsmuster:</label>
              <input name="activeCycle" required />
              <label>Sozialstruktur:</label>
              <input name="socialStructure" required />
              <label>Lebenserwartung:</label>
              <input name="lifeSpan" required />
            </div>

            <!-- Observation & Location -->
            <div class="form-section">
              <h3>Beobachtungsort (Location)</h3>
              <label>Titel:</label>
              <input name="locationShortTitle" required />
              <label>Beschreibung:</label>
              <input name="locationDescription" required />
              <label>Datum der Beobachtung:</label>
              <input type="date" name="date" required />
              <label>Uhrzeit der Beobachtung:</label>
              <input type="time" name="time" required />
              <button type="submit">Aktualisieren</button>
            </div>

          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const id = new URLSearchParams(window.location.search).get("id");

    async function fetchAnimal() {
      const res = await fetch(`/animal-full/${id}`);
      if (!res.ok) {
        alert("❌ Tierdaten konnten nicht geladen werden.");
        return;
      }
      const data = await res.json();
      for (const key in data) {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) field.value = data[key];
      }

      // Bild laden
      const imgRes = await fetch(`/animal/${id}/image`);
      if (imgRes.ok) {
        const blob = await imgRes.blob();
        const url = URL.createObjectURL(blob);
        document.getElementById("currentImage").src = url;
      }
    }

    function previewImage(event) {
      const file = event.target.files[0];
      const preview = document.getElementById("previewImage");
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
        preview.style.display = "none";
      }
    }

    async function deleteImage() {
      const confirmDelete = confirm("Bist du sicher, dass du das Bild löschen möchtest?");
      if (!confirmDelete) return;

      try {
        const res = await fetch(`/animal/${id}/image`, { method: "DELETE" });
        if (res.ok) {
          document.getElementById("currentImage").src = "";
          alert("✅ Bild wurde gelöscht.");
        } else {
          alert("❌ Fehler beim Löschen des Bildes.");
        }
      } catch (err) {
        alert("❌ Fehler: " + err.message);
      }
	  
	  console.log("Sende DELETE an /animal/" + id + "/image");

	  const res = await fetch(`/animal/${id}/image`, { method: "DELETE" });
	  console.log("Statuscode: ", res.status);

    }

    document.getElementById("editForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target;

      const body = {};
      new FormData(form).forEach((value, key) => {
        if (key !== "image") {
          body[key] = value;
        }
      });

      body.estimatedAge = parseInt(body.estimatedAge);
      body.estimatedSize = parseFloat(body.estimatedSize);
      body.estimatedWeight = parseFloat(body.estimatedWeight);

      try {
        const res = await fetch(`/animal-full/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error(await res.text());

        const imageFile = form.image.files[0];
        if (imageFile) {
          const imageForm = new FormData();
          imageForm.append("file", imageFile);

          const imgRes = await fetch(`/animal/${id}/image`, {
            method: "POST",
            body: imageForm
          });

          if (!imgRes.ok) {
            alert("✅ Tierdaten aktualisiert, aber Bild-Upload fehlgeschlagen.");
            return;
          }
        }

        alert("✅ Tier erfolgreich aktualisiert.");
      } catch (err) {
        alert("❌ Fehler: " + err.message);
      }
    });

    fetchAnimal();
  </script>
</body>
</html>
