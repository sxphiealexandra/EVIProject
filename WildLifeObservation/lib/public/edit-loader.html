<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tier bearbeiten</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/createstyles.css" />
  <link rel="stylesheet" href="css/editloaderstyles.css" />
</head>
<body>
  <div class="hero">
    <div class="overlay">
      <div class="form-container">
        <div class="form-header">
          <img src="/img/LogoWildLifeObservation.png" alt="Logo" />
          <h2>Tier bearbeiten</h2>
        </div>
        <form id="editForm">
          <div class="form-row">

            <!-- Animal -->
            <div class="form-section">
              <h3>Tierdaten (Animal)</h3>
              <label>Geschlecht:</label>
              <input name="gender" required />
              <label>Geschätztes Alter:</label>
              <input type="number" name="estimatedAge" required />
              <label>Geschätzte Größe (cm):</label>
              <input type="number" name="estimatedSize" step="0.01" required />
              <label>Geschätztes Gewicht (kg):</label>
              <input type="number" name="estimatedWeight" step="0.01" required />

              <label>Bild hochladen (optional):</label>
              <input type="file" name="image" accept="image/*" />
            </div>

            <!-- Genus -->
            <div class="form-section">
              <h3>Gattung (Genus)</h3>
              <label>Lateinischer Name:</label>
              <input name="latinDesignation" required />
              <label>Deutsche Bezeichnung:</label>
              <input name="designation" required />
              <label>Beschreibung:</label>
              <input name="description" required />
              <label>Familie:</label>
              <input name="family" required />
              <label>Ernährung:</label>
              <input name="diet" required />
              <label>Fortpflanzung:</label>
              <input name="reproductiveStrategy" required />
              <label>Aktivitätsmuster:</label>
              <input name="activeCycle" required />
              <label>Sozialstruktur:</label>
              <input name="socialStructure" required />
              <label>Lebenserwartung:</label>
              <input name="lifeSpan" required />
            </div>

            <!-- Observation & Location -->
            <div class="form-section">
              <h3>Beobachtungsort (Location)</h3>
              <label>Titel:</label>
              <input name="locationShortTitle" required />
              <label>Beschreibung:</label>
              <input name="locationDescription" required />
              <label>Datum der Beobachtung:</label>
              <input type="date" name="date" required />
              <label>Uhrzeit der Beobachtung:</label>
              <input type="time" name="time" required />
              <button type="submit">Aktualisieren</button>
            </div>

          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    async function fetchAnimal() {
      const res = await fetch(`/animal-full/${id}`);
      if (!res.ok) {
        alert("❌ Tierdaten konnten nicht geladen werden.");
        return;
      }
      const data = await res.json();
      for (const key in data) {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) field.value = data[key];
      }
    }

    document.getElementById("editForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target;

      const body = {};
      new FormData(form).forEach((value, key) => {
        if (key !== "image") {
          body[key] = value;
        }
      });

      body.estimatedAge = parseInt(body.estimatedAge);
      body.estimatedSize = parseFloat(body.estimatedSize);
      body.estimatedWeight = parseFloat(body.estimatedWeight);

      try {
        const res = await fetch(`/animal-full/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error(await res.text());

        // Bild-Upload (optional)
        const imageFile = form.image.files[0];
        if (imageFile) {
          const imageForm = new FormData();
          imageForm.append('file', imageFile);

          const imgRes = await fetch(`/animal/${id}/image`, {
            method: "POST",
            body: imageForm
          });

          if (!imgRes.ok) {
            alert("Tier aktualisiert, aber Bild-Upload fehlgeschlagen.");
            return;
          }
        }

        alert("✅ Tier erfolgreich aktualisiert.");
      } catch (err) {
        alert("❌ Fehler: " + err.message);
      }
    });

    fetchAnimal();
  </script>
</body>
</html>
